# reconcile

Package reconcile provides complex multi-source data reconciliation with field-level authority and provenance tracking.

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# reconciler

```go
import "github.com/agentstation/starmap/pkg/reconciler"
```

Package reconciler provides catalog synchronization and reconciliation capabilities. It handles merging data from multiple sources, detecting changes, and applying updates while respecting data authorities and merge strategies.

## Index

- [func ConvertCatalogsMapToSources\(srcs map\[sources.ID\]catalogs.Catalog\) \[\]sources.Source](<#ConvertCatalogsMapToSources>)
- [func NewMockSource\(sourceType sources.ID, catalog catalogs.Catalog\) sources.Source](<#NewMockSource>)
- [type AuthorityStrategy](<#AuthorityStrategy>)
  - [func \(s \*AuthorityStrategy\) ResolveConflict\(field string, values map\[sources.ID\]any\) \(any, sources.ID, string\)](<#AuthorityStrategy.ResolveConflict>)
- [type Merger](<#Merger>)
- [type Option](<#Option>)
  - [func WithAuthorities\(authorities authority.Authority\) Option](<#WithAuthorities>)
  - [func WithBaseline\(catalog catalogs.Catalog\) Option](<#WithBaseline>)
  - [func WithEnhancers\(enhancers ...enhancer.Enhancer\) Option](<#WithEnhancers>)
  - [func WithProvenance\(enabled bool\) Option](<#WithProvenance>)
  - [func WithStrategy\(strategy Strategy\) Option](<#WithStrategy>)
- [type Reconciler](<#Reconciler>)
  - [func New\(opts ...Option\) \(Reconciler, error\)](<#New>)
- [type Result](<#Result>)
  - [func NewResult\(\) \*Result](<#NewResult>)
  - [func \(r \*Result\) Finalize\(\)](<#Result.Finalize>)
  - [func \(r \*Result\) HasChanges\(\) bool](<#Result.HasChanges>)
  - [func \(r \*Result\) IsSuccess\(\) bool](<#Result.IsSuccess>)
  - [func \(r \*Result\) Summary\(\) string](<#Result.Summary>)
  - [func \(r \*Result\) WasApplied\(\) bool](<#Result.WasApplied>)
- [type ResultMetadata](<#ResultMetadata>)
- [type ResultStatistics](<#ResultStatistics>)
- [type SourceOrderStrategy](<#SourceOrderStrategy>)
  - [func \(s \*SourceOrderStrategy\) ResolveConflict\(\_ string, values map\[sources.ID\]any\) \(any, sources.ID, string\)](<#SourceOrderStrategy.ResolveConflict>)
- [type Strategy](<#Strategy>)
  - [func NewAuthorityStrategy\(authorities authority.Authority\) Strategy](<#NewAuthorityStrategy>)
  - [func NewSourceOrderStrategy\(priorityOrder \[\]sources.ID\) Strategy](<#NewSourceOrderStrategy>)
- [type StrategyType](<#StrategyType>)
  - [func \(s StrategyType\) Name\(\) string](<#StrategyType.Name>)
  - [func \(s StrategyType\) String\(\) string](<#StrategyType.String>)
- [type ValidationError](<#ValidationError>)
- [type ValidationResult](<#ValidationResult>)
  - [func \(v \*ValidationResult\) HasWarnings\(\) bool](<#ValidationResult.HasWarnings>)
  - [func \(v \*ValidationResult\) IsValid\(\) bool](<#ValidationResult.IsValid>)
  - [func \(v \*ValidationResult\) String\(\) string](<#ValidationResult.String>)
- [type ValidationWarning](<#ValidationWarning>)


<a name="ConvertCatalogsMapToSources"></a>
## func [ConvertCatalogsMapToSources](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/test_helpers.go#L62>)

```go
func ConvertCatalogsMapToSources(srcs map[sources.ID]catalogs.Catalog) []sources.Source
```

ConvertCatalogsMapToSources converts the old map format to sources slice for testing.

<a name="NewMockSource"></a>
## func [NewMockSource](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/test_helpers.go#L18>)

```go
func NewMockSource(sourceType sources.ID, catalog catalogs.Catalog) sources.Source
```

NewMockSource creates a new mock source for testing.

<a name="AuthorityStrategy"></a>
## type [AuthorityStrategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L102-L105>)

AuthorityStrategy uses field authorities to resolve conflicts.

```go
type AuthorityStrategy struct {
    // contains filtered or unexported fields
}
```

<a name="AuthorityStrategy.ResolveConflict"></a>
### func \(\*AuthorityStrategy\) [ResolveConflict](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L125>)

```go
func (s *AuthorityStrategy) ResolveConflict(field string, values map[sources.ID]any) (any, sources.ID, string)
```

ResolveConflict uses authorities to resolve conflicts.

<a name="Merger"></a>
## type [Merger](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/merger.go#L19-L25>)

Merger performs the actual merging of resources.

```go
type Merger interface {
    // Models merges models from multiple sources
    Models(sources map[sources.ID][]*catalogs.Model) ([]*catalogs.Model, provenance.Map, error)

    // Providers merges providers from multiple sources
    Providers(sources map[sources.ID][]*catalogs.Provider) ([]*catalogs.Provider, provenance.Map, error)
}
```

<a name="Option"></a>
## type [Option](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L30>)

Option is a function that configures a Reconciler.

```go
type Option func(*options) error
```

<a name="WithAuthorities"></a>
### func [WithAuthorities](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L59>)

```go
func WithAuthorities(authorities authority.Authority) Option
```

WithAuthorities sets the field authorities.

<a name="WithBaseline"></a>
### func [WithBaseline](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L92>)

```go
func WithBaseline(catalog catalogs.Catalog) Option
```

WithBaseline sets an existing catalog to compare against for change detection.

<a name="WithEnhancers"></a>
### func [WithEnhancers](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L84>)

```go
func WithEnhancers(enhancers ...enhancer.Enhancer) Option
```

WithEnhancers adds model enhancers to the pipeline.

<a name="WithProvenance"></a>
### func [WithProvenance](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L76>)

```go
func WithProvenance(enabled bool) Option
```

WithProvenance enables field\-level tracking.

<a name="WithStrategy"></a>
### func [WithStrategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/options.go#L45>)

```go
func WithStrategy(strategy Strategy) Option
```

WithStrategy sets the merge strategy.

<a name="Reconciler"></a>
## type [Reconciler](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/reconciler.go#L24-L28>)

Reconciler is the main interface for reconciling data from multiple sources.

```go
type Reconciler interface {
    // Sources reconciles multiple catalogs from different sources
    // The primary source determines which models exist; other sources provide enrichment only
    Sources(ctx context.Context, primary sources.ID, srcs []sources.Source) (*Result, error)
}
```

<a name="New"></a>
### func [New](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/reconciler.go#L41>)

```go
func New(opts ...Option) (Reconciler, error)
```

New creates a new Reconciler with options.

<a name="Result"></a>
## type [Result](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L14-L33>)

Result represents the outcome of a reconciliation operation.

```go
type Result struct {
    // Core data
    Catalog        catalogs.Catalog
    Changeset      *differ.Changeset
    AppliedChanges *differ.Changeset

    // Tracking maps
    ProviderAPICounts map[catalogs.ProviderID]int
    ModelProviderMap  map[string]catalogs.ProviderID

    // Metadata
    Metadata ResultMetadata

    // Provenance tracking
    Provenance provenance.Map

    // Issues
    Errors   []error
    Warnings []string
}
```

<a name="NewResult"></a>
### func [NewResult](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L108>)

```go
func NewResult() *Result
```

NewResult creates a new result with defaults.

<a name="Result.Finalize"></a>
### func \(\*Result\) [Finalize](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L123>)

```go
func (r *Result) Finalize()
```

Finalize calculates duration and marks completion.

<a name="Result.HasChanges"></a>
### func \(\*Result\) [HasChanges](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L74>)

```go
func (r *Result) HasChanges() bool
```

HasChanges returns true if any changes were detected.

<a name="Result.IsSuccess"></a>
### func \(\*Result\) [IsSuccess](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L69>)

```go
func (r *Result) IsSuccess() bool
```

IsSuccess returns true if the reconciliation was successful.

<a name="Result.Summary"></a>
### func \(\*Result\) [Summary](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L84>)

```go
func (r *Result) Summary() string
```

Summary returns a human\-readable summary of the result.

<a name="Result.WasApplied"></a>
### func \(\*Result\) [WasApplied](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L79>)

```go
func (r *Result) WasApplied() bool
```

WasApplied returns true if changes were applied.

<a name="ResultMetadata"></a>
## type [ResultMetadata](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L36-L57>)

ResultMetadata contains metadata about the reconciliation process.

```go
type ResultMetadata struct {
    // StartTime when reconciliation started
    StartTime time.Time

    // EndTime when reconciliation completed
    EndTime time.Time

    // Duration of the reconciliation
    Duration time.Duration

    // Sources that were reconciled
    Sources []sources.ID

    // Strategy used for reconciliation
    Strategy Strategy

    // DryRun indicates if this was a dry-run
    DryRun bool

    // Statistics about the reconciliation
    Stats ResultStatistics
}
```

<a name="ResultStatistics"></a>
## type [ResultStatistics](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/result.go#L60-L66>)

ResultStatistics contains statistics about the reconciliation.

```go
type ResultStatistics struct {
    ModelsProcessed    int
    ProvidersProcessed int
    ConflictsResolved  int
    ResourcesSkipped   int
    TotalTimeMs        int64
}
```

<a name="SourceOrderStrategy"></a>
## type [SourceOrderStrategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L178-L181>)

SourceOrderStrategy resolves conflicts using a fixed source precedence order. Sources earlier in the priority slice have higher precedence than sources later in the slice.

```go
type SourceOrderStrategy struct {
    // contains filtered or unexported fields
}
```

<a name="SourceOrderStrategy.ResolveConflict"></a>
### func \(\*SourceOrderStrategy\) [ResolveConflict](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L202>)

```go
func (s *SourceOrderStrategy) ResolveConflict(_ string, values map[sources.ID]any) (any, sources.ID, string)
```

ResolveConflict uses source priority order to resolve conflicts.

<a name="Strategy"></a>
## type [Strategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L42-L60>)

Strategy defines how reconciliation should be performed.

```go
type Strategy interface {
    // Type returns the strategy type
    Type() StrategyType

    // Description returns a human-readable description
    Description() string

    // ShouldMerge determines if resources should be merged
    ShouldMerge(resourceType sources.ResourceType) bool

    // ResolveConflict determines how to resolve conflicts
    ResolveConflict(field string, values map[sources.ID]any) (any, sources.ID, string)

    // ValidateResult validates the reconciliation result
    ValidateResult(result *Result) error

    // ApplyStrategy returns how changes should be applied
    ApplyStrategy() differ.ApplyStrategy
}
```

<a name="NewAuthorityStrategy"></a>
### func [NewAuthorityStrategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L108>)

```go
func NewAuthorityStrategy(authorities authority.Authority) Strategy
```

NewAuthorityStrategy creates a new authority\-based strategy.

<a name="NewSourceOrderStrategy"></a>
### func [NewSourceOrderStrategy](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L185>)

```go
func NewSourceOrderStrategy(priorityOrder []sources.ID) Strategy
```

NewSourceOrderStrategy creates a new source priority order strategy. The priorityOrder slice determines precedence: earlier elements have higher priority.

<a name="StrategyType"></a>
## type [StrategyType](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L14>)

StrategyType represents the type of reconciliation strategy.

```go
type StrategyType string
```

<a name="StrategyTypeFieldAuthority"></a>

```go
const (
    // StrategyTypeFieldAuthority uses field-specific authority scores to resolve conflicts.
    StrategyTypeFieldAuthority StrategyType = "field-authority"
    // StrategyTypeSourceOrder uses source ordering to resolve conflicts.
    StrategyTypeSourceOrder StrategyType = "source-order"
)
```

<a name="StrategyType.Name"></a>
### func \(StrategyType\) [Name](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L22>)

```go
func (s StrategyType) Name() string
```

Name returns the name of the strategy type.

<a name="StrategyType.String"></a>
### func \(StrategyType\) [String](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/strategy.go#L17>)

```go
func (s StrategyType) String() string
```

String returns the string representation of a strategy type.

<a name="ValidationError"></a>
## type [ValidationError](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L17-L22>)

ValidationError represents a validation error.

```go
type ValidationError struct {
    ResourceType sources.ResourceType
    ResourceID   string
    Field        string
    Message      string
}
```

<a name="ValidationResult"></a>
## type [ValidationResult](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L10-L14>)

ValidationResult represents the result of validating a catalog or changeset.

```go
type ValidationResult struct {
    Valid    bool
    Errors   []ValidationError
    Warnings []ValidationWarning
}
```

<a name="ValidationResult.HasWarnings"></a>
### func \(\*ValidationResult\) [HasWarnings](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L38>)

```go
func (v *ValidationResult) HasWarnings() bool
```

HasWarnings returns true if there are warnings.

<a name="ValidationResult.IsValid"></a>
### func \(\*ValidationResult\) [IsValid](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L33>)

```go
func (v *ValidationResult) IsValid() bool
```

IsValid returns true if validation passed.

<a name="ValidationResult.String"></a>
### func \(\*ValidationResult\) [String](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L43>)

```go
func (v *ValidationResult) String() string
```

String returns a string representation of the validation result.

<a name="ValidationWarning"></a>
## type [ValidationWarning](<https://github.com/agentstation/starmap/blob/master/pkg/reconcile/validation.go#L25-L30>)

ValidationWarning represents a validation warning.

```go
type ValidationWarning struct {
    ResourceType sources.ResourceType
    ResourceID   string
    Field        string
    Message      string
}
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->